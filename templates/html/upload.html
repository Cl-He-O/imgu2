{{template "header" .}}

{{if and (not .user) (not .guest_upload)}}
<div class="alert alert-warning my-3" role="alert">
    You need to <a href="/login">sign in</a> before uploading
</div>
{{end}}

{{template "unverified_email" .}}

<div id="file-area" class="my-3 py-5 border shadow rounded bg-dark text-center">
    <div>
        <div>
            <img style="display: none;" id="preview" class="mw-100">
        </div>
        <div id="prompt" class="py-5">Click Here or Drop Files Here to Upload</div>
    </div>
</div>

<input type="file" id="file-input" class="d-none" accept="image/png,image/jpeg,image/gif,image/webp" multiple>

<div class="mb-2">
    <label class="form-label">Auto delete</label>
    <select class="form-select" id="selectExpire">
        <option value="0" selected>Never</option>
        <option value="300">5 minutes</option>
        <option value="600">10 minutes</option>
        <option value="1800">30 minutes</option>
        <option value="3600">1 hour</option>
        <option value="21600">6 hours</option>
        <option value="43200">12 hours</option>
        <option value="86400">24 hours</option>
        <option value="172800">2 days</option>
        <option value="604800">1 week</option>
        <option value="2592000">30 days</option>
        <option value="15552000">180 days</option>
    </select>
</div>

<div class="mb-2">
    <label class="form-label">Image Format Conversion</label>
    <select class="form-select" id="selectFormat" autocomplete="off">
        <option value="original" selected>Original</option>
        <option value="webp">WebP (animated)</option>
        <option value="png">PNG</option>
        <option value="jepg">JEPG</option>
        <option value="gif">GIF (animated)</option>
        <option value="avif">AVIF</option>
    </select>
</div>

{{template "recaptcha" .}}

<div class="my-3 d-grid">
    <button type="button" class="btn btn-primary" id="btn-upload">Upload</button>
</div>

<div class="my-3 progress" role="progress" style="display: none;" id="progress">
    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%" id="progressbar"></div>
</div>

<script>
    const csrf_token = "{{.csrf_token}}";
    const max_duration = +"{{.max_time}}";
    const recaptcha = "{{.recaptcha_client}}" !== "";

    const fileArea = document.getElementById("file-area");
    const fileInput = document.getElementById("file-input");
    const preview = document.getElementById("preview");
    const prompt = document.getElementById("prompt");
    const btn = document.getElementById("btn-upload");
    const selectExpire = document.getElementById("selectExpire");
    const selectFormat = document.getElementById("selectFormat");
    const progress = document.getElementById("progress");
    const progressbar = document.getElementById("progressbar");

    let uploading = false;

    let file;

    if (max_duration !== 0) {
        while (+(selectExpire.children[selectExpire.children.length - 1].value) > max_duration && +selectExpire.children[selectExpire.children.length - 1].value !== 0) {
            selectExpire.children[selectExpire.children.length - 1].remove();
        }
        selectExpire.children[0].remove(); // remove "never"
    }

    function updatePreview() {
        // display image preview

        if (file !== undefined) {
            preview.style.display = "";
            prompt.style.display = "none";
        } else {
            preview.style.display = "none";
            prompt.style.display = "";
        }

        const reader = new FileReader();
        reader.addEventListener("load", (e) => {
            preview.src = e.target.result;
        })
        reader.readAsDataURL(file);
    }

    fileArea.addEventListener("click", () => {
        if (uploading) return;

        fileInput.click();
    });

    fileInput.addEventListener("change", (e) => {
        file = fileInput.files[0];
        updatePreview();
    });

    btn.addEventListener("click", () => {
        if (!file) return;

        if (recaptcha && !grecaptcha.getResponse()) {
            alert("reCAPTCHA is not completed");
            return;
        }

        uploading = true;

        // hide button & show progress bar
        btn.style.display = "none";
        progress.style.display = "";

        // disable selector
        selectExpire.setAttribute("disabled", "disabled");

        const xhr = new XMLHttpRequest();

        xhr.upload.addEventListener("progress", (e) => {
            // progress
            progressbar.style.width = (e.loaded / e.total * 100) + "%";
        });

        xhr.addEventListener("load", () => {
            if (xhr.status !== 200) {
                if (xhr.responseText === "recaptcha verification failed") {
                    alert("ERROR: ReCAPTCHA verification failed");
                } else if (xhr.responseText === "csrf check failed") {
                    alert("ERROR: CSRF check failed");
                } else {
                    const resp = JSON.parse(xhr.responseText);
                    const errorText = {
                        "GUEST_UPLOAD_NOT_ALLOWED": "You have to sign in before uploading",
                        "USER_BANNED": "Your account has been disabled",
                        "EMAIL_NOT_VERIFIED": "Your email address has not been verified",
                        "EXPIRE_TOO_LARGE": "The auto-delete time exceeds the maximum allowed value",
                        "FILE_TOO_LARGE": "Your uploaded file is too large",
                        "IMAGE_PROCESSING_ERROR": "Your uploaded file is malformatted",
                        "INTERNAL_STORAGE_ERROR": "An unknown error occurred while saving your image"
                    }
                    alert("ERROR: " + errorText[resp.error] || resp.error);
                }
                
                location.reload();
                return;
            }

            const resp = JSON.parse(xhr.responseText);
            location.href = "/preview/" + resp.file_name;
        })

        xhr.addEventListener("error", (e) => {
            console.log(e)
            alert("XMLHttpRequest error");
            location.reload()
        })

        xhr.open("POST", "/upload");

        const formData = new FormData();
        formData.set("file", file);
        formData.set("expire", selectExpire.value);
        formData.set("format", selectFormat.value);
        formData.set("csrf_token", csrf_token);
        if (recaptcha) formData.set("g-recaptcha-response", grecaptcha.getResponse());

        xhr.send(formData);
    });
</script>

{{template "footer" .}}